<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FinChat | Investment Helper</title>

    <!-- Farcaster miniapp metadata (left intact, but the app is now finance-themed) -->
    <meta
      name="fc:miniapp"
      content='{"version":"next","imageUrl":"https://static.vecteezy.com/system/resources/previews/011/995/200/non_2x/geometric-icon-logo-geometric-abstract-element-free-vector.jpg","button":{"title":"Open FinChat","action":{"type":"launch_miniapp","name":"FinChat","url":"/"}}}'
    />
    <script type="module">
      import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk";
      await sdk.actions.ready();
    </script>

    <style>
      :root {
        --bg: #0b1020;
        --card: rgba(255, 255, 255, 0.06);
        --card2: rgba(255, 255, 255, 0.08);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.68);
        --muted2: rgba(255, 255, 255, 0.55);
        --line: rgba(255, 255, 255, 0.12);
        --accent: #76e4f7;
        --accent2: #a7f3d0;
        --warn: #fbbf24;
        --danger: #fb7185;
        --shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--text);
        background:
          radial-gradient(1200px 800px at 10% 10%, rgba(118, 228, 247, 0.18), transparent 55%),
          radial-gradient(900px 600px at 90% 20%, rgba(167, 243, 208, 0.14), transparent 55%),
          radial-gradient(900px 700px at 60% 95%, rgba(251, 191, 36, 0.10), transparent 60%),
          var(--bg);
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px 18px 44px;
      }

      header {
        display: flex;
        gap: 14px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 18px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background:
          radial-gradient(circle at 30% 30%, rgba(118, 228, 247, 0.95), transparent 40%),
          radial-gradient(circle at 80% 70%, rgba(167, 243, 208, 0.85), transparent 45%),
          rgba(255, 255, 255, 0.06);
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.14);
      }

      h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.2px;
      }

      .sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: var(--muted);
        font-size: 12px;
      }

      .grid {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 14px;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 18px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .card h2 {
        margin: 0;
        font-size: 13px;
        letter-spacing: 0.25px;
        color: var(--muted);
        text-transform: uppercase;
      }

      .card .hd {
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--line);
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 10px;
      }

      .card .bd {
        padding: 14px;
      }

      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input[type="text"],
      textarea {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(0, 0, 0, 0.20);
        color: var(--text);
        padding: 12px 12px;
        outline: none;
      }

      textarea {
        resize: vertical;
        min-height: 86px;
        max-height: 240px;
      }

      input[type="text"]:focus,
      textarea:focus {
        border-color: rgba(118, 228, 247, 0.55);
        box-shadow: 0 0 0 4px rgba(118, 228, 247, 0.12);
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .row1 {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .btn {
        appearance: none;
        border: 0;
        border-radius: 14px;
        padding: 12px 12px;
        color: #041018;
        font-weight: 700;
        cursor: pointer;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
      }

      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .btn.secondary {
        background: rgba(255, 255, 255, 0.10);
        color: var(--text);
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.14);
      }

      .tog {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.05);
      }

      .tog .desc {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .tog .desc b {
        font-size: 13px;
        color: var(--text);
      }

      .tog .desc span {
        font-size: 12px;
        color: var(--muted2);
      }

      .switch {
        position: relative;
        width: 48px;
        height: 28px;
        flex: 0 0 auto;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.14);
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        transition: 0.15s;
      }

      .slider:before {
        content: "";
        position: absolute;
        height: 22px;
        width: 22px;
        left: 3px;
        top: 2px;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 999px;
        transition: 0.15s;
      }

      .switch input:checked + .slider {
        background: rgba(118, 228, 247, 0.45);
        border-color: rgba(118, 228, 247, 0.55);
      }

      .switch input:checked + .slider:before {
        transform: translateX(20px);
        background: rgba(255, 255, 255, 0.98);
      }

      .chat {
        display: flex;
        flex-direction: column;
        height: 640px;
      }

      @media (max-width: 900px) {
        .chat {
          height: 620px;
        }
      }

      .log {
        padding: 14px;
        overflow: auto;
        flex: 1;
      }

      .msg {
        display: grid;
        grid-template-columns: 38px 1fr;
        gap: 10px;
        margin-bottom: 12px;
      }

      .avatar {
        width: 38px;
        height: 38px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
      }

      .bubble {
        border-radius: 18px;
        padding: 12px 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.05);
        line-height: 1.35;
        white-space: pre-wrap;
      }

      .mine .bubble {
        background: rgba(118, 228, 247, 0.12);
        border-color: rgba(118, 228, 247, 0.24);
      }

      .meta {
        margin-top: 7px;
        color: var(--muted2);
        font-size: 12px;
      }

      .foot {
        border-top: 1px solid var(--line);
        padding: 12px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: end;
        background: rgba(255, 255, 255, 0.02);
      }

      .note {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(251, 191, 36, 0.25);
        background: rgba(251, 191, 36, 0.08);
        color: rgba(255, 255, 255, 0.80);
        font-size: 12px;
        line-height: 1.35;
      }

      .stat {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .stat .box {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        border-radius: 16px;
        padding: 10px 10px;
      }
      .stat .k {
        font-size: 11px;
        color: var(--muted2);
      }
      .stat .v {
        margin-top: 4px;
        font-weight: 750;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .ok {
        color: var(--accent2);
      }
      .bad {
        color: var(--danger);
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>FinChat</h1>
            <div class="sub">A tiny LLM + yfinance assistant for learning, not crystal-ball prophecy üß†üìà</div>
          </div>
        </div>
        <div class="pill" id="statusPill">üîå LLM: unknown</div>
      </header>

      <div class="grid">
        <section class="card">
          <div class="hd">
            <h2>Controls</h2>
            <span class="small">Ticker optional</span>
          </div>
          <div class="bd">
            <div class="row1" style="margin-bottom: 10px">
              <div>
                <label for="ticker">Ticker symbol</label>
                <input id="ticker" type="text" placeholder="e.g., AAPL, MSFT, TSLA, VUSA.L" />
                <div class="small" style="margin-top: 6px">
                  Tip: for non-US tickers, Yahoo Finance suffixes apply (e.g. <span class="ok">VUSA.L</span>, <span class="ok">SHEL.L</span>).
                </div>
              </div>
              <div class="row">
                <button class="btn secondary" id="btnLoad">Load snapshot</button>
                <button class="btn secondary" id="btnClear">Clear chat</button>
              </div>
            </div>

            <div class="row1" style="margin-bottom: 12px">
              <div class="tog">
                <div class="desc">
                  <b>Fundamentals</b>
                  <span>Company snapshot: PE, cap, dividend, sector</span>
                </div>
                <label class="switch">
                  <input id="togFund" type="checkbox" checked />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="tog">
                <div class="desc">
                  <b>Technicals</b>
                  <span>RSI, SMA, MACD, volatility</span>
                </div>
                <label class="switch">
                  <input id="togTech" type="checkbox" checked />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="tog">
                <div class="desc">
                  <b>Toy backtest</b>
                  <span>SMA 20/50 crossover (educational)</span>
                </div>
                <label class="switch">
                  <input id="togBacktest" type="checkbox" />
                  <span class="slider"></span>
                </label>
              </div>
              <div class="tog">
                <div class="desc">
                  <b>Guardrails</b>
                  <span>Force disclaimers + avoid buy/sell commands</span>
                </div>
                <label class="switch">
                  <input id="togGuard" type="checkbox" checked />
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <div class="note">
              <b>Important:</b> This bot is for education and decision support only, not financial advice.
              Market data comes from <b>yfinance</b> (unofficial, can be delayed or incomplete).
            </div>

            <div style="height: 12px"></div>

            <div class="card" style="background: var(--card2); border-radius: 16px">
              <div class="hd" style="border-bottom: 1px solid var(--line)">
                <h2>Snapshot</h2>
                <span class="small" id="snapMeta">No ticker loaded</span>
              </div>
              <div class="bd">
                <div class="stat" id="snapStats">
                  <div class="box"><div class="k">Price</div><div class="v">-</div></div>
                  <div class="box"><div class="k">Change</div><div class="v">-</div></div>
                  <div class="box"><div class="k">Market cap</div><div class="v">-</div></div>
                  <div class="box"><div class="k">PE (ttm)</div><div class="v">-</div></div>
                </div>
                <div class="small" style="margin-top: 10px" id="snapMore"></div>
              </div>
            </div>
          </div>
        </section>

        <section class="card chat">
          <div class="hd">
            <h2>Chat</h2>
            <span class="small">Ask: ‚ÄúShould I buy‚Ä¶?‚Äù and I‚Äôll give a framework üß∞</span>
          </div>
          <div class="log" id="log"></div>
          <div class="foot">
            <textarea id="msg" placeholder="Ask about a ticker, a plan, or a concept (risk, diversification, DCA, ETFs, drawdowns...)" spellcheck="false"></textarea>
            <button class="btn" id="btnSend">Send</button>
          </div>
        </section>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const fmt = {
        money(x, c) {
          if (x === null || x === undefined || Number.isNaN(Number(x))) return "-";
          try {
            return new Intl.NumberFormat(undefined, {
              style: "currency",
              currency: c || "USD",
              maximumFractionDigits: 2,
            }).format(Number(x));
          } catch {
            return `${Number(x).toFixed(2)} ${c || ""}`.trim();
          }
        },
        pct(x) {
          if (x === null || x === undefined || Number.isNaN(Number(x))) return "-";
          const n = Number(x);
          const s = n >= 0 ? "+" : "";
          return `${s}${n.toFixed(2)}%`;
        },
        big(n) {
          if (n === null || n === undefined || Number.isNaN(Number(n))) return "-";
          const x = Number(n);
          const abs = Math.abs(x);
          const unit =
            abs >= 1e12 ? [1e12, "T"] : abs >= 1e9 ? [1e9, "B"] : abs >= 1e6 ? [1e6, "M"] : abs >= 1e3 ? [1e3, "K"] : [1, ""];
          return `${(x / unit[0]).toFixed(2)}${unit[1]}`;
        },
      };

      function addMsg({ who, text, meta }) {
        const el = document.createElement("div");
        el.className = `msg ${who === "me" ? "mine" : ""}`;
        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = who === "me" ? "üßë" : "ü§ñ";
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;
        const wrap = document.createElement("div");
        wrap.appendChild(bubble);
        if (meta) {
          const m = document.createElement("div");
          m.className = "meta";
          m.textContent = meta;
          wrap.appendChild(m);
        }
        el.appendChild(avatar);
        el.appendChild(wrap);
        $("log").appendChild(el);
        $("log").scrollTop = $("log").scrollHeight;
      }

      function settings() {
        return {
          fundamentals: $("togFund").checked,
          technicals: $("togTech").checked,
          backtest: $("togBacktest").checked,
          guardrails: $("togGuard").checked,
        };
      }

      function renderSnapshot(s) {
        const boxes = $("snapStats").querySelectorAll(".box .v");
        boxes[0].textContent = fmt.money(s.price, s.currency);
        boxes[1].textContent = fmt.pct(s.change_pct);
        boxes[1].className = `v ${s.change_pct !== null && s.change_pct < 0 ? "bad" : "ok"}`;
        boxes[2].textContent = s.market_cap ? fmt.big(s.market_cap) : "-";
        boxes[3].textContent = s.pe ? s.pe.toFixed(2) : "-";
        $("snapMeta").textContent = `${s.ticker}${s.name ? " ‚Ä¢ " + s.name : ""}`;
        const more = [];
        if (s.sector) more.push(`Sector: ${s.sector}`);
        if (s.industry) more.push(`Industry: ${s.industry}`);
        if (s.forward_pe) more.push(`Forward PE: ${Number(s.forward_pe).toFixed(2)}`);
        if (s.eps) more.push(`EPS (ttm): ${Number(s.eps).toFixed(2)}`);
        if (s.dividend_yield) more.push(`Dividend yield: ${Number(s.dividend_yield).toFixed(2)}%`);
        if (s.beta) more.push(`Beta: ${Number(s.beta).toFixed(2)}`);
        $("snapMore").textContent = more.join(" ¬∑ ");
      }

      async function loadSnapshot() {
        const t = $("ticker").value.trim();
        if (!t) {
          $("snapMeta").textContent = "No ticker loaded";
          return;
        }
        $("btnLoad").disabled = true;
        try {
          const r = await fetch(`/api/snapshot/?ticker=${encodeURIComponent(t)}`);
          const data = await r.json();
          if (!data.ok) throw new Error(data.error || "Snapshot error");
          renderSnapshot(data.snapshot);
          $("statusPill").textContent = "‚úÖ Data: loaded";
        } catch (e) {
          $("statusPill").textContent = "‚ö†Ô∏è Data: error";
          addMsg({ who: "bot", text: `Snapshot failed: ${e.message}` });
        } finally {
          $("btnLoad").disabled = false;
        }
      }

      async function send() {
        const message = $("msg").value.trim();
        if (!message) return;
        $("msg").value = "";
        addMsg({ who: "me", text: message });

        const t = $("ticker").value.trim();
        const payload = { message, ticker: t, settings: settings() };
        $("btnSend").disabled = true;
        $("btnSend").textContent = "Thinking‚Ä¶";

        try {
          const r = await fetch("/api/chat/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify(payload),
          });
          const data = await r.json();
          if (!data.ok) {
            $("statusPill").textContent = "üîå LLM: not configured";
          } else {
            $("statusPill").textContent = "‚ú® LLM: online";
          }
          addMsg({
            who: "bot",
            text: data.reply || "(no reply)",
            meta: t ? `Context: ${t.toUpperCase()} ¬∑ fundamentals=${payload.settings.fundamentals ? "on" : "off"}, technicals=${payload.settings.technicals ? "on" : "off"}${payload.settings.backtest ? ", backtest=on" : ""}` : "Context: general",
          });

          // If the user didn't click "Load snapshot", we still try to paint it when returned.
          if (data.snapshot) renderSnapshot(data.snapshot);
        } catch (e) {
          addMsg({ who: "bot", text: `Request failed: ${e.message}` });
        } finally {
          $("btnSend").disabled = false;
          $("btnSend").textContent = "Send";
        }
      }

      function clearChat() {
        $("log").innerHTML = "";
        addMsg({
          who: "bot",
          text:
            "Hi! Tell me what you‚Äôre considering and I‚Äôll help you think it through.\n\nExamples:\n‚Ä¢ ‚ÄòIs AAPL overvalued for a 5 year hold?‚Äô\n‚Ä¢ ‚ÄòI‚Äôm new, how do I build a diversified portfolio?‚Äô\n‚Ä¢ ‚ÄòCompare VUSA.L vs. CSP1.L for UK investors.‚Äô",
        });
      }

      $("btnLoad").addEventListener("click", loadSnapshot);
      $("btnSend").addEventListener("click", send);
      $("btnClear").addEventListener("click", clearChat);
      $("msg").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });

      // Initial greeting
      clearChat();
    </script>
  </body>
</html>
